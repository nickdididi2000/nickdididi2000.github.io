---
title: "Spatial Analysis of Elevated Blood Lead Levels in Twin Cities Area"
author: "Nicholas Di and Erin Franke"
description: | 
  This project was conducted for the capstone course: STAT 452 Correlated Data. We analyzed elevated blood lead levels in Minneapolis/Saint Paul area through spatial data!
preview: https://www.esmagazine.com/ext/resources/2021/06/25/lead-pipes.jpeg?1624678185
date: 5-11-2022
output:
  distill::distill_article:
    self_contained: false
bibliography: Library.bib
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
```

```{r, message=FALSE, warning=FALSE, results = 'hide'}
library(tidycensus)
library(tidyverse)
library(survey)
library(srvyr)
library(sf)
library(ggtext)
library(broom)
library(tidymodels)
library(spdep)
library(probably)
tidymodels_prefer()
conflicted::conflict_prefer("spautolm", "spatialreg")

#see DataCleaning.Rmd for data cleaning steps
load("DataShapefiles/lead_spatial.RData")
river_lakes <- st_read("DataShapefiles/shp_water_lakes_rivers")
roads <- st_read("DataShapefiles/tl_2019_27_prisecroads")
# roads_sub <- st_crop(roads,st_bbox(lead_census))
```

# Introduction 

When raising a child, parents go through lots of stress to keep their children safe and healthy. From using car seats to getting children vaccinated to working on speech and mobility development and beyond, there is a lot to think about. But one aspect that may be overlooked in providing safe and healthy environment for a child is lead. Lead in paint, soil, air, or water is invisible to the naked eye and has no smell [@cdcPrevention]. However, children can be exposed to lead in a variety of manners, including swallowing house dust or soil contaminated by lead paint or drinking water delivered through lead-based pipes, faucets, and plumbing fixtures. Exposure to this hidden element can seriously harm a child's health, including damage to the child's brain and nervous system, slowed growth and development, as well as learning, hearing, speech, and behavior problems [@cdcPrevention]. If exposed to especially high levels of lead, children can face a brain condition known as encephalopathy, severe neurological damage, comas, and even death [@leadoverview]. Thus, without a question it is crucial to keep lead exposure to a minimum when raising a child. 

In this project, we analyzed elevated blood lead levels in the **7 county Twin Cities metropolitan area** using public data provided by the **Minnesota Department of Health** over the period of 2015-2019 [@mdhdata]. To protect the privacy of individuals, the smallest granularity we were able to obtain this data was on the census tract level, meaning for each of the 691 census tracts in the Twin Cities metropolitan area we obtained information on how many children were tested and how many of those tests resulted in elevated blood lead levels. To have **elevated blood lead levels (EBLLs)** means that a child has a confirmed result **at or above 5 micrograms of lead per deciliter of blood (mcg/dL)** [@leadoverview]. Children under 6 years of age are tested. The Minnesota Department of Health identifies children living in the Minneapolis and Saint Paul city limits as children at a higher risk for lead exposure and recommends these children to receive blood lead testing at 1 and 2 years of age. This recommendation is warranted given that in 2019, between 1-2% of children in Minneapolis or St. Paul had EBLLs, which is double the statewide average and higher than any other region of Minnesota [@leadoverview]. Interestingly, the MDH has found children living in the Metro area but not living in the cities of Minneapolis or St. Paul are at a lower risk of lead exposure than the Greater Minnesota (non-Metro) are. Only about 0.3% of these children have elevated blood lead levels whereas about 0.8% of children living in MN outside the metro area have elevated blood lead levels. As a result, to best explore this contrast between Minneapolis-Saint Paul and the suburban region, this project will solely focus on EBLL data from the 7 county Twin Cities metro area. This region is shown in navy on the road map of Minnesota below. 

```{r}
lead_census %>%
  ggplot()+
  geom_sf(fill = "navy", lwd = 0.2, color = "navy")+
  geom_sf(data = roads, fill = "lightblue",color = "lightblue", lwd=0.2)+
  theme_classic()+
  labs(title = "Twin Cities Metropolitan region on MN road map")+
  theme(axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        legend.position = "none", 
        plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono"), 
        plot.subtitle = element_markdown(family = "mono", size = 8))+
  scale_fill_manual(values = c("navy", "red"))
```

# Research Goal

Keeping the health consequences of lead exposure to children in the front of our minds, our research focuses on investigating what is correlated with a census tract having a noticeably high proportion of children testing with elevated blood lead levels. We defined a tract to be a "high lead tract" if at least 1% of the tests in the tract resulted in elevated blood lead levels (meaning 5+ mcg lead/dL). This left us with 106 "high lead" tracts and 585 "safe" tracts. The location of these "high lead" tracts in the Twin Cities metropolitan area can be seen below in red. It is clear that the majority of them fall in the Minneapolis-Saint Paul city limits. 

```{r}
river_lakes_big <- river_lakes %>%
  filter(AREA_ACRES >= 500)
roads_metro <- st_crop(roads,st_bbox(lead_census))
lead_census %>%
  ggplot()+
  geom_sf(aes(fill=as.factor(HighLead)), lwd = 0.2, color = "white")+
  geom_sf(data = river_lakes_big, fill = "lightblue",color = "lightblue")+
  theme_classic()+
  labs(title = "Elevated blood lead levels in the Twin Cities", subtitle = "<strong><span style='color:red'>Red tracts have at least 1% of children tested with high elevated blood levels</span></strong></b>")+
  theme(axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        legend.position = "none", 
        plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono"), 
        plot.subtitle = element_markdown(family = "mono", size = 8))+
  scale_fill_manual(values = c("navy", "red"))
```

The reason why this research question is important is because understanding what is correlated with tracts having high lead levels can help the Minnesota Department of Health, organizations, and families protect children from lead exposure. For example, it wouldn't be unreasonable to expect tracts with older homes to have higher lead levels, as these homes are more likely to have been built when science did not know the harms of lead pipes and paint. On March 28, 2022, Saint Paul Mayor Melvin Carter announced a $14.5 million American Rescue Plan investment to remove thousands of lead pipes across the city [@saintpaul]. If home age appears a strong indicator of high lead levels, identifying tracts with old homes, high lead levels, and lots of young children can alert the city to replace their pipes first. In our research we also might search for a relationship between testing, income, and lead levels. If we are to find certain income groups getting tested more or less than others holding other variables constant, we can shed light on that and advocate for resources to get specific tracts the testing they need and deserve given their exposure. 

To help us understand what is correlated with a tract being "high lead", we will need more than just the information provided by the MDH of tract lead levels. Using the **tidycensus** [@tidycensus] package in R, we can access a plethora of information on each census tract including its estimated mean age, mean income, population, proportion of family households, home age, and so much more. We begin by exploring the relationship between many of these variables and testing as well as EBLLs.

# Exploratory Data Analysis 

## Estimated Home Age and EBLLs

One of the first variables we decided to explore was estimated home age. Using the tidycensus package, we were able to access the number of residences in each census tract built prior to 1950, between 1950-1959, 1960-1969, etc. We made these variables proportions by dividing the number of homes built in each time period by the total number of homes in the census tract. Most revealing was the proportion of homes built prior to 1950 - as seen in the map below, the Minneapolis-Saint Paul city limits are largely composed of these older homes while the tracts on the outskirts of the city have few very homes built before 1950.

```{r}
lead_census %>%
  ggplot()+
  geom_sf(aes(fill = propHomesBuiltPre1950), lwd = 0.2, color = "white")+
  theme_classic()+
  labs(title = "Proportion of homes built before 1950 by Twin Cities census tract", fill = "")+
  theme(axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono", size = 9))+
  scale_fill_viridis_c()
```

Given this visualization and our knowledge of history, it is clear that home age likely plays a strong role in lead exposure in children. But it can't be the only factor. In the map below, we again identify tracts with at least 1% of tests registering with elevated blood lead levels. These tracts are colored red and pink, though *in the pink tracts less than 25% of homes were built before 1950*. We see these pink tracts generally are located outside the MSP city limits in more recently developed suburban areas. 

```{r}
lead_census %>%
  mutate(highleadNewHome = case_when(HighLead == "1" & propHomesBuiltPre1950 <= 0.25 ~ 2, 
                                     HighLead == "1" & propHomesBuiltPre1950 > 0.25 ~ 1,
                                     TRUE ~ 0)) %>%
  ggplot()+
  geom_sf(aes(fill=as.factor(highleadNewHome)), lwd = 0.2, color = "white")+
  geom_sf(data = river_lakes_big, fill = "lightblue",color = "lightblue")+
  theme_classic()+
  labs(title = "Elevated blood lead levels in the Twin Cities", subtitle = "<strong><span style='color:red'>Red and pink tracts have at least 1% of children tested with EBLLs </span></strong></b>")+
  theme(axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        legend.position = "none", 
        plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono"), 
        plot.subtitle = element_markdown(family = "mono", size = 8))+
  scale_fill_manual(values = c("navy", "red", "pink"))
```

Comparing these pink tracts we have denoted as "high lead" tracts that contain less than 25% of homes built before 1950 to tracts we have denoted as having safe lead levels, there are a few things to notice. Our first thought was that perhaps these pink tracts were still significantly older than the safe lead level tracks and were just built largely in the 1960s and 70s. Lead-based paint and lead-contaminated dust are the most common sources of lead poisoning, and paint containing lead was not banned in the United States until 1978 [@washHealth]. Therefore, any home built prior to 1978 could certainly serve as an exposure threat to children. It ended up that on average 56.1% percent of the homes in the pink tracts were built before 1979 compared to 54.8% of homes in the safe lead tracts. With such a small difference, there has to be something else correlated with a higher proportion of tests with EBLLs in particular tracts. Looking into other variables, we found the pink high lead tracts have a slightly higher population density at about 2 people/1000 $\text{m}^2$ than the safe lead tracts at 1.4 people/1000 $\text{m}^2$. Additionally, these pink high lead tracts have an estimated median income of \$63,431, whereas the safe lead tracts have an estimated median income of almost \$87,661. Lead exposure can also come through occupation (people exposed to lead through jobs in fields such as auto repair, mining, pipe fitting, battery manufacturing, painting, and construction can bring it home on their clothing), soil, pottery, herbal and folk remedies, the ingredient tamarind in candy, and cosmetics [@mayo]. Given the significant difference in median income between the pink high lead tracts and the safe lead tracts, it is possible that residents from the pink high lead tracts live a different lifestyle than residents in the safe lead tracts that causes them to be exposed to lead at a higher rate. Exactly how this lead exposure is happening is a mystery that we cannot currently solve given the data we have, but the identification of these somewhat unexpected "high lead" tracts is crucial as it can help direct resources and information toward these tracts in order to reduce lead exposure.

```{r, eval=FALSE}
lead_census %>%
  mutate(highleadNewHome = case_when(HighLead == "1" & propHomesBuiltPre1950 <= 0.25 ~ 2, 
                                     HighLead == "1" & propHomesBuiltPre1950 > 0.25 ~ 1,
                                     TRUE ~ 0), 
         area = st_area(geometry),
         density = PopE/area) %>%
   st_drop_geometry() %>%
  group_by(highleadNewHome) %>%
  summarize(mean(PopE), mean(medageE), pre1950 = mean(propHomesBuiltPre1950, na.rm=TRUE), from50to69 = mean(propHomesBuilt1950to1969, na.rm=TRUE),from70to79 = mean(propHomesBuilt1970to1979, na.rm=TRUE), mean(propHomesBuilt1970to1989, na.rm=TRUE), mean(propHomesBuilt1990to2009, na.rm=TRUE), mean(propHomesBuilt2010tonow, na.rm=TRUE), mean(SSIRecpE, na.rm=TRUE), mean(medincomeE, na.rm=TRUE), mean(density, na.rm=TRUE), before79 = sum(pre1950, from50to69, from70to79)) 
```

## Who is getting tested?

A large factor of obtaining high lead percentages is related to how often an area is tested. As more tests are issued, it is more likely we will observe a high lead percentage since the census tract is taking precautions and responding to factors that already cause EBLLs. It is interesting that there is a population within "high lead" census tracts of tracts with newer homes that aren't getting tested at a high rate. We defined a "high rate" of testing to be when the number of tests in the tract is less than the estimated number of children who are 0 to 5 age. These specific census tracts are shown in yellow on the map below and seem to be located outside of the cities. We are unsure exactly why this is, but perhaps it is a result of poor news and communication in terms of safely precautions for high lead levels. 

```{r}
lead_census_clean <- lead_census %>%
  filter(!is.na(medincomeE), !is.na(medageE), !is.na(propHomesBuiltPre1950), !is.na(tested))
lead_census_clean <- lead_census_clean %>% 
  mutate(WhyUNoTest = case_when(TestingHigh == 0 & CensusAgeE < 66 & HighLead == 1 ~ 1,
                                TRUE ~ 0))
lead_census_clean %>%
  ggplot()+
  geom_sf(aes(fill = as.factor(WhyUNoTest)), lwd = 0.2, color = "white")+
  theme_classic()+
  labs(title = "High Lead tracts with new houses but a low testing ratio", fill = "")+
  theme(axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono", size = 9), 
        legend.position = "none")+
  scale_fill_viridis_d()
```

Doing some further investigation using our binary variables indicative of high lead and high testing as well as an estimated tract home age variable, we note some interesting patterns. As we noted with the map above, there are several tracts with on average newer homes that have over 1% of tests with EBLLs but are not getting tested at a high rate. Again, this may be the result of ignorance or delayed news. Additionally, among the census tracts that have a high testing ratio, tracts denoted as "high lead" tend to have a significantly higher estimated home age, which is intuitive as older homes tend to have lead pipes. Furthermore, looking at the relationship between estimated tract median income and testing, we see higher income census tracts are getting tested *less* compared to lower income census tracts. This is intuitive as lower income census tracts may be more risk in terms of living in older houses and thus face higher lead exposure. 

```{r, out.width='45%'}
lead_testing <- lead_census_clean %>%
  st_drop_geometry() %>%
  mutate(testRatio = tested/numChildtestingage, 
         CensusAgeE = propHomesBuiltPre1950 * runif(1, 72,122) + propHomesBuilt1950to1969*62.5 + propHomesBuilt1970to1989*42.5 + propHomesBuilt1990to2009*22.5 + propHomesBuilt2010tonow*6, highIncome = case_when(medincomeE > 100000 ~ "highInc",
                                TRUE ~ "lowerInc"),
         Homecat = cut(CensusAgeE, 3), 
         multipleTest = case_when(testRatio > 1 ~ "manyTest",
                                  TRUE ~ "lessTest"))
facet_names <- c(
                    "manyTest" = "More Than 1 Test Per Child",
                    "lessTest" = "Less Than 1 Test Per Child")

lead_testing %>% ggplot(aes(x = CensusAgeE, fill = factor(HighLead)))+
  geom_density(alpha = 0.35)+
  facet_wrap(~multipleTest, labeller = as_labeller(facet_names)) +
  theme_classic() +
  labs(y="", x="Average Census House Age (In years)", fill ="Lead Level") +
  scale_fill_manual(values = c("navy", "red"), labels = c("Low","High"))+
  theme(plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono", size = 10), 
        axis.text = element_markdown(family = "mono"), 
        axis.title = element_markdown(family="mono", size = 8),
        legend.title = element_markdown(family = "mono", size = 8),
        legend.text = element_markdown(family = "mono"), 
        strip.text = element_text(family = "mono"), 
        strip.background = element_blank(), 
        axis.text.y = element_blank())
  

lead_testing %>%
  filter(HighLead == 1) %>%
  ggplot(aes(x=medincomeE, fill = multipleTest))+
  geom_density(alpha=0.5)+
  labs(fill ="", x = "Median Income in Census Tract", y = "")+
  scale_fill_manual(values = c("red", "navy"), labels = c("less than 1 test/child"," more than 1 test/child")) +
  theme_classic()+
  theme(plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono", size = 10), 
        axis.text = element_markdown(family = "mono"), 
        axis.title = element_markdown(family="mono", size = 8),
        legend.text = element_markdown(family = "mono"), 
        axis.text.y = element_blank())
```

## Modeling 

In the upcoming section, we will be modeling the binary outcome of whether a census tract is considered to be "high lead" or not. As a reminder, we denoted a tract as "high lead" if over 1% of tests contained elevated blood lead levels. The majority of these tracts are located in the Twin Cities. 

## Lasso 

We use LASSO logistic regression to distinguish important variables in predicting census tracts with high lead concentrations. After tuning for the best penalty, we discovered that income, proportions of homes built before 1950, testing ratio (number of tests/child aged 0 to 5), number of tests total, and median age of the census tract are important variables in modeling the variance of high lead levels. However, it is difficult to account for spatial correlation using LASSO, so we will not be interpreting the output and standard errors. Instead, we will take the important variables LASSO identified and fit a random effect model. The one exception to this is we will drop variable indicating the total number of tests and soley use testing ratio, as it is better indicative of whether the number of tests a tract receives is appropriate for their population. This random effect model will account for spatial correlation. Spatial correlation is very important in our study as census tracts that are close together will share many similar characteristics in regards to income, community, and more. Leaving this unaccounted for will result in correlated residuals. 

```{r, include=FALSE, fig.show='hide'}
# MODEL RECIPE AND TUNING
set.seed(123)

lasso_log_variables <- lead_census %>%
  mutate(HighLead = as.factor(HighLead), 
         HighLead = relevel(factor(HighLead), ref="0"), 
         testRatio = tested/numChildtestingage) %>% 
  select(HighLead, medageE, medincomeE, NumHouseE, PopE, propFamilyHouseholds, propHomesBuiltPre1950, SSIRecpE, CensusAgeE, tested, MarrCoupleChldU3E, testRatio, GEOID) %>%
  drop_na() %>% st_drop_geometry()

data_cv10 <- vfold_cv(lasso_log_variables, v = 10)

logistic_lasso_spec_tune <- logistic_reg() %>%
    set_engine('glmnet') %>%
    set_args(mixture = 1, penalty = tune()) %>%
    set_mode('classification')

logistic_rec <- recipe(HighLead~medageE + medincomeE + NumHouseE + PopE + propFamilyHouseholds + propHomesBuiltPre1950 + SSIRecpE + CensusAgeE + tested + MarrCoupleChldU3E +testRatio, data = lasso_log_variables) %>%
    step_normalize(all_numeric_predictors()) %>% 
    step_dummy(all_nominal_predictors())

log_lasso_wf <- workflow() %>% 
    add_recipe(logistic_rec) %>%
    add_model(logistic_lasso_spec_tune) 

penalty_grid <- grid_regular(
  penalty(range = c(-10, 10)), 
  levels = 100)

tune_output <- tune_grid( 
  log_lasso_wf, 
  resamples = data_cv10, 
  metrics = metric_set(roc_auc,accuracy),
  control = control_resamples(save_pred = TRUE, event_level = 'second'),
  grid = penalty_grid 
)

autoplot(tune_output) + theme_classic()

# BEST SE PENALTY
best_se_penalty <- select_by_one_std_err(tune_output, metric = 'roc_auc', desc(penalty)) 
best_se_penalty

final_fit_se <- finalize_workflow(log_lasso_wf, best_se_penalty) %>%
    fit(data = lasso_log_variables)

# Variables not driven to 0: medageE, medincomeE, propHomesBuiltPre1950, tested, testRatio
final_fit_se %>% tidy()

# VARIABLE IMPORTANCE
glmnet_output <- final_fit_se %>% extract_fit_engine()
    
bool_predictor_exclude <- glmnet_output$beta==0

var_imp <- sapply(seq_len(nrow(bool_predictor_exclude)), function(row) {
    this_coeff_path <- bool_predictor_exclude[row,]
    ncol(bool_predictor_exclude) - which.min(this_coeff_path) + 1
})

var_imp_data <- tibble(
    var_name = rownames(bool_predictor_exclude),
    var_imp = var_imp
)
var_imp_data %>% arrange(desc(var_imp))
```

```{r, include=FALSE, results='hide'}
final_output <- final_fit_se %>% predict(new_data = lasso_log_variables, type='prob') %>% bind_cols(lasso_log_variables)

final_output %>%
    roc_curve(HighLead, .pred_1,event_level = 'second') %>%
    autoplot()

threshold_output <- final_output %>%
    threshold_perf(truth = HighLead, estimate = .pred_0, thresholds = seq(0,1,by=.01)) 

threshold_output %>%
    filter(.metric == 'j_index') %>%
    ggplot(aes(x = .threshold, y = .estimate)) +
    geom_line() +
    labs(y = 'J-index', x = 'threshold') +
    theme_classic()

#Chose a threshold of 0.85 to predict HighLead
threshold_output %>%
    filter(.metric == 'j_index') %>%
    arrange(desc(.estimate))

log_metrics <- metric_set(accuracy,sens,yardstick::spec)

# Model gives an accuracy of 79.69% with a sensitivity of 87.7% and specificity of 77.05%
final_output %>%
    mutate(.pred_class = make_two_class_pred(.pred_0, levels(HighLead), threshold = .85)) %>%
    log_metrics(truth = HighLead, estimate = .pred_class, event_level = 'second')

# Final predictions 
final_lasso_preds <- lead_census %>%
  select(GEOID) %>%
  right_join(final_output, by = "GEOID") %>%
  mutate(.pred_class = make_two_class_pred(.pred_0, levels(HighLead), threshold = .85))
```

## Matern Random Effect Models

Essentially, a Matern random effects model takes into account the correlation between points via the euclidean distance between coordinates. Our random effect model accounts for spatial correlation by incorporating the X and Y coordinates of the centroid, or center, of each census tract. We are able to do so by creating a numeric factor representing the coordinates of sampled locations. We fit a constant nu (smoothness parameter) for easier computational purposes. We use a nu value of 0.5, which means the Matern correlation is equivalent to spatial exponential decay. Because we have the matern correlation coefficient, we do assume isotropic, meaning that the covariance function depends only on the computational distance. 

We use this model as it is an alternative way to account for spatial correlation, by imposing a correlation structure on the random effect so that each census tract are spatially correlated. In absence of the random effect, neighboring census tracts will have spatially correlated residuals. When two regions are farther away, we expect the correlation between them to get lower. Rho is a measure of range correlation, therefore a higher value of rho implies more spatial correlation being captured by the model. 

We fit two different models, one with our designated important variables from LASSO and another with an interaction between the proportion of homes built before 1950 and a categorical income variable. This interaction suggests that income plays a different role among high lead levels conditioned on proportion of hold homes. Perhaps if we are at a high income level and have high proportion of old homes, we may see reduced probability of high lead levels due to the ability to renovate. 

```{r, results = "hide"}
# logistic_mod1 <- fitme(HighLead ~ medincomeE + propHomesBuiltPre1950 + testRatio + medageE + Matern(1 | X+Y), fixed = list(nu = 0.5), family = binomial(), data=mod1data,control.HLfit = list(algebra='decorr'))
#logistic_mod1 <- fitme(HighLead ~ medincomeE + propHomesBuiltPre1950 + tested + testRatio + medageE + Matern(1 | X+Y), fixed = list(nu = 0.5), family = binomial(), data=final_lasso_preds,control.HLfit = list(algebra='decorr'))

mod1 <- readRDS("logistic_mod1_edited.rds")
summary(mod1)

# logistic_mod2 <- fitme(HighLead ~ IncomeCategory*propHomesBuiltPre1950 + testRatio + medageE + Matern(1 | X+Y), fixed = list(nu = 0.5), family = binomial(), data=mod2data,control.HLfit = list(algebra='decorr'))

mod2 <- readRDS("logistic_mod2_edited.rds")
summary(mod2)

```

Now that we have our two models, we can evaluate them. We decided to use a threshold of 70% to predict if a census tract is to be considered in the high lead category or not. This means that if the logistic regression gives us a predicted probability of .70 or higher, we will make a hard prediction that the census area is high lead. We chose a threshold of .70 as it is gives us the best sensitivity. In the context of EBLL, a threshold of 0.70 gives us the most accuracy in correctly determining a census tract with high lead levels. 

The signs of all coefficients make sense. As income increases, the odds ratio decreases by 0.852 for every 1000 dollar increase in median income holding other variables constant. This is in check with our understanding as the more income a household has, the more likely they will be able to remodel and replace lead pipes. Additionally, the more income a census tract has, the more newer houses we may see. The proportion of homes built before 1950 is the most statistically significant coefficient. As per the first model, a percentage increase in a proportion of homes built before 1950 will increase odds ratio of a tract being high lead by 1.25 holding other variables constant. Finally, the coefficient on the test ratio variable is also positive, indicating an increase in odds of a census tract being high lead as their test ratio increases. This is intuitive as tracts that are testing more are likely doing so because they face higher exposure.

Our interaction terms in the second model were all non-significant. Meaning, under the model, category of income did not impact high lead differently despite being conditioned on the proportion of houses built before 1950. Although all statistically insignificant, income classes that suffered the most from greater houses built before 1950 were the census tracts with lowest median income.

Why does our prediction have 100% accuracy? Spatial random effect will help improve the prediction because it is using neighboring information to account for that spatial correlation, doing so more in the mean structure and actually change the prediction, conditioned on random effects and getting more precise and improved conditions, rather than marginal mean prediction. Hence why we have a 100% prediction accuracy for both models, because of the random effect that is able to capture variations that are unobservant. 

```{r, results='hide'}
mod1data <- final_lasso_preds %>% 
  mutate(medincomeE = medincomeE/1000,
         propHomesBuiltPre1950 = propHomesBuiltPre1950*100)
mod1_prediction <- mod1data %>% 
  mutate(probability = predict(mod1, data = final_lasso_preds)) %>% 
  mutate(predHighLead = case_when(probability >= 0.7~1,
                                  probability < 0.7~0))

Accuracy_mod1 <- final_lasso_preds %>% 
  mutate(probability = predict(mod1, data = final_lasso_preds)) %>% 
  mutate(predHighLead = case_when(probability >= 0.70~1,
                                  probability < 0.70~0)) %>% 
  mutate(Correct = case_when(predHighLead == HighLead ~ "correct",
                             predHighLead != HighLead ~ "incorrect")) %>% 
  st_drop_geometry() %>% 
  group_by(Correct) %>% 
  count()

mod2data <- final_lasso_preds%>%
  mutate(IncomeCategory = case_when(medincomeE > 0 & medincomeE < 60000 ~ "low",
                                    medincomeE >= 60001 & medincomeE < 80000 ~ "medlow",
                                    medincomeE >= 80001 & medincomeE < 100000 ~ "medhigh",
                                    medincomeE >= 100001 ~ "high"))  %>% 
  mutate(medincomeE = medincomeE/1000,
         propHomesBuiltPre1950 = propHomesBuiltPre1950*100) 

mod2_prediction <- mod2data %>% na.omit() %>% 
  mutate(probability = predict(mod2, data = mod2data)) %>% 
  mutate(predHighLead = case_when(probability >= 0.7~1,
                                  probability < 0.7~0))

Accuracy_mod2 <- mod2data %>% na.omit() %>% 
  mutate(probability = predict(mod2, data = final_lasso_preds)) %>% 
  mutate(predHighLead = case_when(probability >= 0.70~1,
                                  probability < 0.70~0)) %>% 
  mutate(Correct = case_when(predHighLead == HighLead ~ "correct",
                             predHighLead != HighLead ~ "incorrect")) %>% 
  st_drop_geometry() %>% 
  group_by(Correct) %>% 
  count()

Accuracy_mod1
Accuracy_mod2
```

```{r, out.width='45%'}
mod1_prediction %>%
  ggplot() +
  geom_sf(aes(fill = as.factor(predHighLead)))+
  scale_fill_manual(values = c("navy", "red"))+
  theme_classic()+
  geom_sf(data=river_lakes_big, fill="lightblue")+
  labs(title = "Logistic model predictions for lead levels in Twin Cities Metro", fill = "High Lead Predicted")+
  theme(axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        legend.title = element_text(family = "mono", size = 9),
        plot.title = element_text(family = "mono", size =11), 
        plot.title.position = "plot", 
        legend.text = element_text(family = "mono"))
mod2_prediction %>%
  ggplot() +
  geom_sf(aes(fill = as.factor(predHighLead)))+
  scale_fill_manual(values = c("navy", "red"))+
  theme_classic()+
  geom_sf(data=river_lakes_big, fill="lightblue")+
  labs(title = "Logistic model predictions (w/ Interaction) for lead levels in Twin Cities Metro", fill = "High Lead Predicted")+
  theme(axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        legend.title = element_text(family = "mono", size = 9),
        plot.title = element_text(family = "mono", size =11), 
        plot.title.position = "plot", 
        legend.text = element_text(family = "mono"))

lead_census_clean %>%
  ggplot() +
  geom_sf(aes(fill = as.factor(HighLead)))+
  scale_fill_manual(values = c("navy", "red"))+
  theme_classic()+
  geom_sf(data=river_lakes_big, fill="lightblue")+
  labs(title = "Actual high lead census tracts in Twin Cities Metro", fill = "High Lead")+
  theme(axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        legend.title = element_text(family = "mono", size = 9),
        plot.title = element_text(family = "mono", size =11), 
        plot.title.position = "plot", 
        legend.text = element_text(family = "mono"))
```

# Modeling the percent of children by census tract with EBLLs

Thus far, we have developed a model to predict whether or not a census tract will have at least 1% of tests return with an indication of EBLLs. But its important to acknowledge that not all census tracts that we have denoted as "high lead" have the same proportion of tests indicating EBLLs. For the 106 "high lead" tracts, the distribution of the proportion of tests indicating EBLLs is shown below. 

```{r}
dotplot <- lead_census %>%
  filter(HighLead == "1") %>%
  mutate(outlier = case_when(percent >= 0.1 ~ 1, 
                             TRUE ~ 0)) %>%
  ggplot(aes(x=percent, fill = as.factor(outlier)))+
  geom_dotplot(dotsize = 0.9)+
  theme_classic()+
  scale_fill_manual(values = c("black","darkred"))+
  scale_x_continuous(breaks = c(0.01, 0.03, 0.05, 0.07, 0.09, 0.11), labels = scales::percent_format(accuracy = 1)) +
  labs(x="", y="", title = "Percent of tests having EBLLs for the 106 <strong><span style='color:red'>high lead </span></strong></b>census tracts")+
  theme(plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono", size = 10), 
        axis.text = element_markdown(family = "mono"), 
        axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(), 
        legend.position = "none")

ramsey <- lead_census %>%
  filter(primary_county == "Ramsey County") %>%
  ggplot()+
  geom_sf(aes(fill=percent), lwd = 0.2, color = "black")+
  theme_classic()+
  labs(title = "", fill = "")+
  theme(axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        legend.position = "none", 
        plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono", size=8),
        legend.title = element_text(family="mono"))+
  scale_fill_gradient(low = "white", high = "darkred")

library(cowplot)
  ggdraw() +
  draw_plot(dotplot) +
  draw_plot(ramsey, x = 0.5, y = .3, width = .5, height = .5)+
    annotate(geom="text", label = "Two outlier \ncensus tracts in \nRamsey county", family = "mono", size = 3, x = 0.76, y = 0.28, color = "darkred")+
    geom_curve(aes(x = 0.75, y = 0.2, xend = 0.85, yend = 0.15),
  arrow = arrow(length = unit(0.03, "npc")), color = "darkred")
```

In order to better understand this distribution and what is correlated with certain tracts having a higher percentage of tests with EBLLs than others, we will build a model for this percentage using solely the 106 "high lead" tracts. Similar to our logistic model building process to predict whether or not a tract is "high lead", we will begin with a LASSO regression model. Variables that remain in the model after the shrinkage process can be thought of as most important at helping us identify why certain tracts have a higher percentage of tests with EBLLs than others.

```{r, results = "hide", include=FALSE}
lasso_percent_variables <- lead_census %>%
  mutate(HighLead = as.factor(HighLead), 
         HighLead = relevel(factor(HighLead), ref="0"), 
         testRatio = tested/numChildtestingage, 
         area = st_area(geometry),
         density = PopE/area) %>% 
  select(HighLead, medageE, medincomeE, NumHouseE, PopE, propFamilyHouseholds, propHomesBuiltPre1950, SSIRecpE, CensusAgeE, tested, MarrCoupleChldU3E, testRatio, GEOID, propHomesBuilt1950to1969, propHomesBuilt1970to1989, propHomesBuilt1990to2009, propHomesBuilt2010tonow, percent, density) %>%
  filter(HighLead == "1") %>%
  drop_na() %>% st_drop_geometry()

set.seed(123)
percent_cv10 <- vfold_cv(lasso_percent_variables, v = 10)

lm_lasso_spec_tune <- 
  linear_reg() %>%
  set_args(mixture = 1, penalty = tune()) %>% 
  set_engine(engine = 'glmnet') %>%
  set_mode('regression') 

percent_rec <- recipe(percent ~., data = lasso_percent_variables) %>%
  update_role(GEOID, new_role = "ID") %>% # we don't want to use ID as predictor
  step_novel(all_nominal_predictors()) %>% 
  step_dummy(all_nominal_predictors()) %>% 
  step_nzv(all_predictors()) %>%
  step_normalize(all_numeric_predictors())  # important step for LASSO

lasso_wf_percent <- workflow() %>% 
  add_recipe(percent_rec) %>%
  add_model(lm_lasso_spec_tune) 

penalty_grid <- grid_regular(
  penalty(range = c(-5, 3)), #log10 transformed 10^-5 to 10^3
  levels = 50)

tune_res <- tune_grid( # new function for tuning hyperparameters
  lasso_wf_percent, # workflow
  resamples = percent_cv10, # folds
  metrics = metric_set(rmse),
  grid = penalty_grid # penalty grid
)

autoplot(tune_res)

collect_metrics(tune_res) %>%
  filter(.metric == 'rmse') %>%
  select(penalty, rmse = mean) 

best_penalty <- select_best(tune_res, metric = 'rmse', desc(penalty)) 
percent_final_wk <- finalize_workflow(lasso_wf_percent, best_penalty) # incorporates penalty value to workflow
percent_final_fit <- fit(percent_final_wk, data = lasso_percent_variables)
tidy(percent_final_fit)

percent_final_fit %>% predict(new_data = lasso_percent_variables)

# we can predict the percent of high lead children on average within 1.5% 
tune_res %>% collect_metrics() %>% filter(penalty == (best_penalty %>% pull(penalty)))

lasso_mod_out <- percent_final_fit %>%
    predict(new_data = lasso_percent_variables) %>%
    bind_cols(lasso_percent_variables) %>%
    mutate(resid = percent - .pred)

lasso_mod_out %>% 
  ggplot(aes(x = .pred, y = resid)) + 
  geom_point() +
  geom_smooth(se = FALSE) + 
  geom_hline(yintercept = 0) + 
  theme_classic()
```

Using 10-fold cross validation on our 106 census tracts, the LASSO modeling process identified tract population, the proportion of homes built between 1950 and 1969, the proportion of homes built before 1950, and the estimated mean receipt of supplemental security income (SSI) for households with children under 18 as the most important predictors of percentage of tests with EBLLs. Interestingly, population and amount of SSI both showed a negative relationship with percentage of tests with EBLLs, meaning more highly populated tracts tend to have a lower proportion of tests with EBLLs holding other variables constant. Additionally, tracts receiving more SSI per household tend to have a lower proportion of tests with EBLLs holding other variables constant. These relationships are shown in the plots below. 

```{r, out.width='45%'}
lead_census %>%
  filter(HighLead == "1") %>%
  ggplot(aes(x=PopE, y=percent))+
  geom_point()+
  theme_classic()+
  labs(title = "Tract population vs percent of tests with EBLLs", x="", y="")+
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
  theme(plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono", size = 10), 
        axis.text = element_markdown(family = "mono"))

lead_census %>%
  filter(HighLead == "1") %>%
  ggplot(aes(x=SSIRecpE, y=percent))+
  geom_point()+
  theme_classic()+
  labs(title = "SSI Reciepts ($) vs percent of tests with EBLLs", x="", y="")+
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
  theme(plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono", size = 10), 
        axis.text = element_markdown(family = "mono"))
```

The reasoning for this phenomena could be that such higher populated and impoverished tracts are viewed "higher risk" for lead exposure and have received greater resources to prevent it thus far.

Now that we have our model, we can evaluate it. The model appears solid with a RMSE of about 1.5%, meaning on average our prediction of a tract's proportion of tests with EBLLs was either too high or too low by about 1.5%. While this is amount of error is relatively small, our model must also have residuals that do not have spatial autocorrelation. As we have discussed, spatial autocorrelation means residuals in one census tract are related to the residuals in the census tracts around it, which is problematic because we violate the assumption of independence of residuals and jeopardize the validity of hypothesis tests. We can test for spatial autocorrelation with something called the Moran's I test. In order to run the Moran's I test, we must decide in what way we want to define census tracts as "close". In other words, we must define a **neighborhood structure**. There are many options when defining a neighborhood structure. We can define tracts as neighbors if they touch at all, even just at one point such as a corner. This is called the Queen neighborhood structure. Another option is the Rook neighborhood structure, which defines tracts as neighbors if they share an edge (more than just a corner). Neighbors can also be defined using distance. The KNN method calculates the distance between the centers (or centroids) of each census tract, and then defines a neighborhood based on K nearest tracts, distanced based on the centers [@heggeseth_2022]. Because we are only looking at census tracts with high lead levels, some tracts do not touch and thus we will use the KNN structure with 4 neighbors. 4 neighbors gives a nice balance between not having too many neighbors (which makes census tracts almost always correlated) and not having too few neighbors, making it harder to pick up on spatial correlation. The KNN(4) structure is shown below. 

```{r}
lasso_results <- lead_census %>%
  filter(HighLead == 1) %>%
  select(GEOID) %>%
  right_join(lasso_mod_out, by = "GEOID")

high_metro_centroids <- st_centroid(st_geometry(lasso_results), of_largest_polygon = TRUE)
knn <- knn2nb(knearneigh(high_metro_centroids, k = 4))
nb_knn_net <- nb2lines(nb = knn, coords = high_metro_centroids, as_sf = TRUE)

lasso_results %>%
  select(resid) %>%
  st_join(lead_census,.) %>%
    ggplot() + 
  geom_sf(size=.05,fill='white') + 
  geom_sf(data = lasso_results,fill = "lightblue",size=.1) + 
  geom_sf(data=high_metro_centroids, lwd = 0.5)+
  geom_sf(data = nb_knn_net, lwd = 0.25)+
  labs(title = "KNN(4) Neighborhood Structure for High Lead Tracts", fill = "") + 
  theme_classic()+
  theme(axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        plot.title = element_text(family = "mono", size =11), 
        plot.title.position = "plot")
```

```{r, results = "hide"}
Wb <- nb2listw(knn, style = "B") #style = 'B' gives binary weights
spdep::moran.test(lasso_results$resid, Wb, alternative = "two.sided", randomisation = TRUE)  # Using randomization test
```

Using the Moran's I test with the KNN(4) structure shown above, there is very strong evidence to reject our null hypothesis of no spatial correlation between neighboring tracts. We thus conclude that census tracts closer together tend to have similar percentages of tests with EBLLs than census tracts further apart. Given this, we will need to use a model that accounts for this spatial autocorrelation. Two models that can potentially accomplish this are the **simultaneous autoregressive model (SAR)** and the **conditional autoregressive model (CAR)**. These models are fit in a similar way to an ordinary least squares model as we predict percent of tests with EBLLs using our selected variables, however, we add a component to the model that allows us to use surrounding neighborhood values at varying weights to estimate percentage of tests with EBLLs for each tract.  After fitting both a CAR and SAR model using the four variables selected by LASSO and the KNN(4) neighborhood structure, we compared them using BIC and the Moran's I test. From the Moran's I test we learned the SAR model yielded strong evidence in support of independent residuals. This evidence was significantly weaker for the CAR model, implying remaining spatial autocorrelation in the residuals. The BIC (a criterion used for model selection) was also superior for the SAR model in comparison to the CAR model, and thus we decided to proceed with the SAR structure. While we tested multiple other SAR models with different combinations of explanatory variables, the model with the four variables selected by LASS0 proved our best model with the lowest average prediction error (about 1.4%). 

```{r, results="hide"}
library(spatialreg)

Ww <- nb2listw(knn, style = "W")
Wb <- nb2listw(knn, style = "B")

#SAR model
mod_sar <- spautolm(formula = percent~ PopE + propHomesBuiltPre1950 + SSIRecpE + propHomesBuilt1950to1969, data = lasso_results, listw = Ww, family = "SAR")
summary(mod_sar)
BIC(mod_sar)

lasso_results$mod_sar_knn <- resid(mod_sar)
sqrt(mean(lasso_results$mod_sar_knn^2))
spdep::moran.test(lasso_results$mod_sar_knn, Wb, alternative = "two.sided", randomisation = TRUE)

#CAR model 
mod_car <- spautolm(formula = percent~ PopE + propHomesBuiltPre1950 + SSIRecpE + propHomesBuilt1950to1969, data = lasso_results, listw = Ww, family = "CAR")
summary(mod_car)
BIC(mod_car)

lasso_results$mod_car_knn <- resid(mod_car)
spdep::moran.test(lasso_results$mod_car_knn, Wb, alternative = "two.sided", randomisation = TRUE)
```

While the average predictor error of our model is relatively small at 1.4%, one obvious downfall of this model is that it did not predict any census tract to have a percent of tests with EBLLs above 5.6%, as seen below. In reality - as shown in the dotplot earlier in this modeling section - seven tracts had a percent of tests with EBLLs over 6% and two tracts had levels over 10%. Thus, our model does not quite capture as large of a distribution in tract percentages as well as we might have liked. 

```{r}
lasso_results$sar_pred <- fitted(mod_sar)

lasso_results %>%
  select(sar_pred) %>%
  st_join(lead_census,.) %>%
    ggplot() + 
  geom_sf(size=.05,fill='white') + 
  geom_sf(data = lasso_results,aes(fill = sar_pred),size=.2) + 
  labs(title = "Percent of Tests with High Lead Blood Levels: SAR Predictions", fill = "") + 
  scale_fill_gradient(low = "lightpink", high = "darkred", labels = scales::percent_format(accuracy = 1)) + 
  theme_classic()+
  theme(axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        plot.title = element_text(family = "mono", size =11), 
        plot.title.position = "plot", 
        legend.text = element_text(family = "mono"))
```

Despite this, our model does indeed do a good job of not systematically over or under-predicting particular areas of the Twin Cities metropolitan area. We see that tracts both inside and outside city limits have a mix of positive and negative residuals and there are several areas where percent of tests with EBLLs are over predicted in one tract and under predicted in its neighboring tract. Given the strong evidence that spatial autocorrelation was accounted for from the Moran's I test, this is not surprising. 

```{r}
lasso_results %>%
  select(mod_sar_knn) %>%
  st_join(lead_census,.) %>%
    ggplot() + 
  geom_sf(size=.05,fill='white') + 
  geom_sf(data = lasso_results,aes(fill = mod_sar_knn),size=.2) + 
  labs(title = "SAR Residuals for percent of tests with EBLLs", fill = "") + 
  scale_fill_gradient2(low = "navy", mid = "white", high = "darkred", labels = scales::percent_format(accuracy = 1)) + 
  theme_classic()+
  theme(axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        plot.title = element_text(family = "mono", size =11), 
        plot.title.position = "plot", 
        legend.text = element_text(family = "mono"))
```

The biggest takeaway from our model is what we can learn about lead exposure patterns using it. Takeaways are generally similar to the LASSO regression model we fit, but we now have more certainty in our coefficient estimates and their significance given we are not breaking the assumption of independent residuals. The two significant coefficients on the $\alpha=0.05$ level in our model are tract population and the proportion of homes built from 1950 to 1969 in each tract. With regard to population, we estimate for every additional 1000 people residing in a tract that the proportion of tests with EBLLs falls on average 0.4%, holding other variables constant. Given that census tracts are intended to have similar populations (ideally ~4000 people), this might not seem practically significant at first. However, the 106 "high lead" tracts have populations ranging from about 2,000 to over 10,000 people per tract, with the majority falling in the 3000 to 6000 range. Thus, comparing a 6,000 resident to 3,000 resident tract, we'd expect the 6,000 resident tract to have a percent of tests with EBLLs about 1.2% lower than that of the 3,000 resident tract, which is a considerable difference. When looking at our second significant variable, we learn that with every 10% increase in the proportion of homes built between 1950 and 1969 we can expect the percent of tests with EBLLs to decrease about 0.4%, holding other variables constant. This relationship is shown in the graph below on the left and is rather interesting when contrasted to the graph on the right, which displays proportion of homes built before 1950 versus percent of tests with EBLLs for "high lead" tracts. The key takeaway here is that as tracts tend to have more homes built between 1950-1969, **their percent of tests with EBLLs tends to fall**, while as tracts tend to have more homes built prior to 1950 their **percent of tests with EBLLs tends to rise**. Given that lead paint was not banned in the United States until 1978, this contrasting relationship is surprising and implies lead paint is not the sole factor causing tracts to have a high percent of tests with EBLLs.

```{r, out.width='45%'}
lead_census %>%
  filter(HighLead == "1") %>%
  ggplot(aes(x=propHomesBuilt1950to1969, y=percent))+
  geom_point()+
  theme_classic()+
  labs(title = "Proportion of homes built from 1950-1969 vs percent of tests with EBLLs", x="percent of homes built 1950-1969", y="percent of tests with EBLLs")+
  scale_x_continuous(labels = scales::percent_format(accuracy = 1))+
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
  theme(plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono", size = 10), 
        axis.text = element_markdown(family = "mono"), 
        axis.title = element_markdown(family="mono", size = 8))

lead_census %>%
  filter(HighLead == "1") %>%
  ggplot(aes(x=propHomesBuiltPre1950, y=percent))+
  geom_point()+
  theme_classic()+
  labs(title = "Proportion of homes built pre 1950 vs percent of tests with EBLLs", x="percent of homes built before 1950", y="percent of tests with EBLLs")+
  scale_x_continuous(labels = scales::percent_format(accuracy = 1))+
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
  theme(plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono", size = 10), 
        axis.text = element_markdown(family = "mono"), 
        axis.title = element_markdown(family="mono", size = 8))
```

To learn a little more about what might be happening, we created the following graph which shows the remaining home age distribution for high lead tracts based on the proportion of homes built from 1950-1969. We see that tracts with very few homes (less than 20%) built from 1950-1969 are composed on average by over 50% of homes built before 1950. These tracts also have the smallest proportion of homes built from 1970-1989. As the proportion of home built 1950-1969 increases, the proportion of homes built before 1950 in the tract decreases and the proportion of homes built 1970-1989 increases. This implies overall higher average home age and helps to explain why we see that relationship we see in our model.

```{r}
lead_census %>%
  filter(HighLead == "1") %>%
  st_drop_geometry() %>%
  mutate(homes195069 = case_when(propHomesBuilt1950to1969 <= 0.2 ~ "Under 20 % built 1950-1969",
                                 propHomesBuilt1950to1969 > 0.2 & propHomesBuilt1950to1969 <= 0.4 ~ "20 - 40% built 1950-1969",
                                 TRUE ~ "Above 40% built 1950-1969")) %>%
  group_by(homes195069) %>%
  summarize(pre1950 = mean(propHomesBuiltPre1950), from1950to1969 = mean(propHomesBuilt1950to1969), from1970to1989 = mean(propHomesBuilt1970to1989), from1990to2009 = mean(propHomesBuilt1990to2009), from2010tonow = mean(propHomesBuilt2010tonow)) %>%
  pivot_longer(cols = pre1950:from2010tonow, names_to = "time", values_to = "proportion") %>%
  mutate(time = case_when(time == "pre1950" ~ "pre 1950",
                          time == "from1950to1969" ~ "1950-1969",
                          time == "from1970to1989" ~ "1970-1989", 
                          time == "from1990to2009" ~ "1990-2009",
                          TRUE ~ "since 2010")) %>%
  mutate(time = factor(time, levels = c("pre 1950", "1950-1969", "1970-1989", "1990-2009", "since 2010")),
         homes195069 = factor(homes195069, levels = c("Under 20 % built 1950-1969", "20 - 40% built 1950-1969", "Above 40% built 1950-1969"))) %>%
  ggplot(aes(x=time, y=proportion,fill= time))+
  geom_col(position = "dodge")+
  facet_wrap(~homes195069)+
  theme_classic()+
  scale_fill_manual(values = c("darkred", "darkgrey", "navy", "darkgreen", "goldenrod"))+
  labs(title = "Remaining home age distribution for high lead tracts", subtitle = "Based on proportion of homes built 1950-1969", x="",y="")+
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
  theme(plot.title = element_text(family = "mono"),
        plot.subtitle = element_text(family = "mono"),
        strip.text = element_text(family = "mono", face = "bold"),
        strip.background = element_blank(), 
        axis.text.x = element_text(angle = 0, size = 6), 
        legend.position = "none", 
        axis.text.y = element_text(family = "mono"))
```

The SSI and proportion of homes built before 1950 variables are both insignificant in this model, though have coefficient directions that make intuitive sense given what we have discussed thus far. Holding other variables constant, as the proportion of homes in a tract built prior to 1950 increases, the percent of tests with EBLLs in that tract increases. Additionally, as discussed when interpreting the LASSO model, tracts receiving more SSI tend to have a lower percentage of tests with EBLLs holding other variables constant.

# Limitations

One of the main limitations in our analysis was data. While we are incredibly thankful to have access to public lead data and demographics on the census tract level, we had been hoping to complete a spatial-temporal analysis looking at the percent of tests with EBLLs in each tract each year dating back to the early 2000s. Unfortunately, the Minnesota Department of Health did not have this data on hand. An additional goal of our was to look at building-specific data available through ArcGIS on lead piping for the St. Paul Regional Water Services (SPRWS) area and incorporate it into our analysis. However, we ran out of time to learn how to web scrape this and so this will be a task for the near future. One other limitation related to the data for this project is that many of the variables we used are estimates. For example, mean tract age is estimated from ACS and census data. Home values come from government valuations which is done for tax purposes. The fact that there is likely a fair amount of error in these estimates should be taken into account when interpreting model coefficients. Also related to the topic of modeling is that fact that no neighborhood structure we choose is going to be perfect. For example, we chose to use the KNN(4) neighborhood structure for our models, which defines four neighbors for every tract using distances between tract centroids. However, it is possible that tracts could be similar in other ways. Tracts close in distance could be incredibly different due to a highway running between them, while tracts further apart but both bordering the river could actually be more similar. 

Furthermore, our models will not be the best to predict new data outside of our dataset. If we have a new census tract added, it will be difficult to account for the spatial correlation. The new observation may be farther away in distance that it will become independent and we will not gain the extra predictive ability. However, we can use the distributions from the matern random effect models to attempt in making a prediction for a new area. Unfortunately, we are not able to explain everything. 

# Conclusions

Throughout our research report, we focused on what seems to be correlated to high lead levels. We anlyzed data from the **7-county Twin Cities metropolitan area** using public data provided by the **Minnesota Department of Health** over the period of 2015-2019 [@mdhdata]. We fit LASSO models to pick out "important" variables and utilize different spatial correlation regressions to obtain accurate standard errors on the coefficients. 

Overall, the age of homes in the tract and median income of census tracts seem to be the most important factors when looking at the variation in high lead levels. This is intuitive as old houses, mentioned earlier, tend to have older pipes, more dust, paint chips, all of which have a causal effect leading to high lead levels. Among houses with high lead levels, as tract population increases and proportions of homes built between 1950-1969 increases we see that the percent of tests returning EBLLs decreases holding other variables constant.  

Furthermore among census tracts with high lead exposure, there is a specific subgroup of tracts that do not test often (test less than once per child) and have a new home age. This is potentially dangerous as families living in these census tracts may go on about their routine thinking living in a newer household is safe when in reality there may be other factors that contribute to high lead exposure. This is especially concerning as testing rates tend to be lower and the percent of tests with EBLLs are higher in these census tracts. For future research, it will be worthwhile to investigate which census tracts are getting tested more often than others and look into other observable factors that may capture the culture within a census tract with regards to lead levels. 

# Acknowledgements 

We thank the Minnesota Department of Health and creators of the tidycensus package for providing publicly available data that made our work possible. We also give a big thank you to our professor Brianna Heggeseth for teaching us the mapping and modeling techniques used in this analysis, as well as for providing support and resources throughout this project. 

# References 
